#!/usr/bin/env bash

set -e

usage()
{
  printf "usage: pocamlc [-d] -f <path_to_pml_file>"
  printf
  printf "options:"
  printf "-c	Clean C object files from previous build before rebuild."
  printf "-d	Compile Pocaml C builtins with debugging information."
  printf "-r	Run the executable after compilation."
  printf "-h	Display pocamlc usage."
}


CLEAN_PREV_BUILD=false
RUN_AFTER_COMPILATION=false
POCAMLC_FLAGS=""
fpath=""
fname=""
basename=""

[[ $@ ]] || { usage; exit 1; }

# parse options and argument
while getopts 'cdrf:h' opt; do
  case $opt in
    c) CLEAN_PREV_BUILD=true;;
    d) POCAMLC_FLAGS+=" -D BUILTIN_DEBUG" ;;
    r) RUN_AFTER_COMPILATION=true;;
    f) fpath=$OPTARG;
       fname=${fpath##*/}
       basename="${fname%.*}" ;;
    h | *) usage
       exit ;;
  esac
done


# important names
build_dir="_pml_build"
builtins_ar="pml_builtins.a"
prelude_dir="prelude"


# get tools
POCAML="dune exec -- bin/main.exe"
LLI=lli
LLC=llc
CC=cc


# create build_dir
rm -rf $build_dir
mkdir $build_dir

# copy source file to build_dir
cp ${fpath} ${build_dir}/${fname}.orig

# prepend prelude
fname_with_prelude=${build_dir}/${fname}
touch $fname_with_prelude
for prelude_file in ${prelude_dir}/**; do
    printf "(* pocamlc: ${prelude_file} *)\n" >> $fname_with_prelude
    cat $prelude_file >> $fname_with_prelude
    printf "\n" >> $fname_with_prelude
done
printf "(* pocamlc: ${fname} *)\n" >> $fname_with_prelude
cat ${build_dir}/${fname}.orig >> $fname_with_prelude


# pocaml -> llvm
$POCAML -c ${build_dir}/${fname} > ${build_dir}/${basename}.ll

# build builtins C static library
cd builtins
[ "$CLEAN_PREV_BUILD" = true ] && make clean
make PML_CFLAGS="${POCAMLC_FLAGS}"
cp ${builtins_ar} ../${build_dir}
cd ..

# link the generated llvm with builtin
cd ${build_dir}
$LLC -relocation-model=pic ${basename}.ll > ${basename}.s
$CC -o ${basename}.exe ${basename}.s ${builtins_ar}

# execute
[ "$RUN_AFTER_COMPILATION" = true ] && ./${basename}.exe

# exit
exit 0
